<!DOCTYPE html>
<html>
	<head>
		<title>radio4000-player</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width">
		<style>
			/* some styles used to make this page nice */
			html {
				box-sizing: border-box;
			}
			*, *:before, *:after {
				box-sizing: inherit;
			}
			:root {
				--size: 1em;
			}
			body {
				margin: 0;
				min-height: 100vh;
				display: flex;
				justify-content: center;
				padding: var(--size);
			}
			body,
			radio-manager,
			radio-manager slot {
				display: flex;
				flex-direction: column;
			}
			slot[name="manager"] {
				padding: var(--size);
			}
		</style>
	</head>

	<body>
		<script async src="https://cdn.jsdelivr.net/npm/radio4000-player"></script>
		<script>
			template = `
				<slot name="manager">
					<form>
						<span>radio4000.com/</span>
						<input name="slug" placeholder="radio4000 channel slug"/>
						<button type="submit">set channel</button>
					</form>
				</slot>
				<slot name="player">
					<radio4000-player
								channel-slug="good-time-radio"
						></radio4000-player>
				</slot>
				<slot name="iframe">
					<textarea disabled="true"></textarea>
				</slot>
			`
			class RadioManager extends HTMLElement {
				static get observedAttributes() {
					return ['channel-slug']
				}
				get channelSlug() {
					const params = new URLSearchParams(window.location.search)
					const slug = params.get('slug')
					return slug || this.getAttribute('channel-slug') || 'good-time-radio'
				}
				set channelSlug(str) {
					this.setAttribute('channel-slug', str)
					const params = new URLSearchParams(window.location.search)
					params.set('slug', str)
					const newRelativePathQuery = window.location.pathname + '?' + params.toString()
					history.pushState(null, '', newRelativePathQuery)
				}

				state = {}

				connectedCallback() {

					this.innerHTML = template
					this.$manager = this.querySelector('slot[name="manager"]')
					this.$player = this.querySelector('slot[name="player"] radio4000-player')
					this.$iframe = this.querySelector('slot[name="iframe"] textarea')

					if (this.channelSlug) {
						this.renderPlayer()
						this.renderForm()
						this.renderIframe()
					}
				}
				onChannel() {
					if (this.state.slug) {
						this.channelSlug = this.state.slug
						this.renderPlayer()
						this.renderIframe()
					}
				}
				renderPlayer() {
					this.$player.setAttribute('channel-slug', this.channelSlug)
				}
				handleInput = (event) => {
					this.state[event.target.name] = event.target.value
				}
				renderForm() {
					this.$manager.querySelectorAll('input').forEach($input => {
						$input.addEventListener('input', this.handleInput)
					})
					this.$manager.addEventListener('submit', (event) => {
						event.preventDefault()
						this.onChannel()
					})
				}
				renderIframe() {
					const iframe =`<iframe src="https://api.radio4000.com/embed?slug=${this.channelSlug}" width="320" height="500" frameborder="0"></iframe>`
					this.$iframe.innerHTML = iframe
				}
			}
			customElements.define('radio-manager', RadioManager)
		</script>

		<header class="SiteHeader">
			<h1 class="SiteTitle">radio4000-player</h1>
			<p>
				This is a demo of the radio4000 player's latest version;
				<a href="https://github.com/internet4000/radio4000-player">documentation</a>.
			</p>
		</header>
		<radio-manager></radio-manager>
	</body>
</html>
